# WireGuard Easy — доступ к домашней сети из любой точки мира

> ⚠️ **Важно:** Эта инструкция предназначена для пользователей со **статическим IP-адресом** от провайдера. Если у вас динамический IP, потребуется дополнительная настройка DDNS.

## Схема работы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           ИНТЕРНЕТ                                      │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Статический IP (например, 85.xxx.xxx.xxx)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         ДОМАШНИЙ РОУТЕР                                 │
│                        (192.168.1.1)                                    │
│                                                                         │
│   Проброс порта: 51820 UDP → 192.168.1.100:51820                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    │ Локальная сеть (192.168.1.0/24)
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    ДОМАШНИЙ СЕРВЕР / ВМ                                 │
│                      (192.168.1.100)                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      WG-Easy (Docker)                             │  │
│  │                    VPN-сеть: 10.8.0.0/24                          │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    ▲
                                    │ WireGuard туннель (UDP 51820)
                                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                    КЛИЕНТ (телефон/ноутбук)                             │
│                         VPN IP: 10.8.0.2                                │
│                                                                         │
│   Получает доступ к:                                                    │
│   • Домашним сервисам (192.168.1.x)                                     │
│   • Интернету через домашнюю сеть                                       │
└─────────────────────────────────────────────────────────────────────────┘
```

## Требования

- Ubuntu 24.04 (или другой Linux)
- Docker и Docker Compose
- Статический IP-адрес от провайдера
- Проброшенный порт 51820/UDP на роутере

## 1. Установка Docker

```bash
curl -fsSL https://get.docker.com | sh
```

Если докер не поставился в автозапуск самостоятельно:

```bash
systemctl enable docker
```

## 2. Создание конфигурации

```bash
mkdir -p /opt/wg-easy
cd /opt/wg-easy
```

Создайте файл `docker-compose.yml`:

```yaml
services:
  wg-easy:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wg-easy
    environment:
      - WG_HOST=ВАШ_СТАТИЧЕСКИЙ_IP
      - PASSWORD_HASH=$$2a$$12$$ваш_хеш_пароля
      - WG_DEFAULT_ADDRESS=10.8.0.x
      - WG_DEFAULT_DNS=192.168.1.1
      - WG_ALLOWED_IPS=0.0.0.0/0
      - WG_PERSISTENT_KEEPALIVE=25
    volumes:
      - ./data:/etc/wireguard
    network_mode: host
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    restart: unless-stopped
```

### Пояснения к параметрам

| Параметр         | Описание                                                                                                                                                                       |
| ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `WG_HOST`        | Ваш **статический IP-адрес**, который вы приобрели у провайдера. Именно по этому адресу клиенты будут подключаться к VPN.                                                      |
| `PASSWORD_HASH`  | Хеш пароля для веб-интерфейса (см. ниже как сгенерировать). **Обратите внимание:** символ `$` в docker-compose нужно экранировать как `$$`.                                    |
| `WG_DEFAULT_DNS` | DNS-сервер для VPN-клиентов. В большинстве домашних сетей это **IP-адрес роутера** (обычно `192.168.1.1` или `192.168.0.1`). Узнать можно командой `ip route \| grep default`. |
| `WG_ALLOWED_IPS` | `0.0.0.0/0` — весь трафик клиента пойдёт через VPN.                                                                                                                            |

### Генерация PASSWORD_HASH

```bash
docker run -it ghcr.io/wg-easy/wg-easy wgpw 'ВАШ_ПАРОЛЬ'
```

Команда выдаст хеш вида:

```
PASSWORD_HASH='$2a$12$abc123...'
```

**Важно:** При вставке в `docker-compose.yml` замените каждый `$` на `$$`:

```
$2a$12$abc... → $$2a$$12$$abc...
```

## 3. Настройка виртуальной машины

### Включение IP-форвардинга

Чтобы VPN-клиенты могли обращаться к локальным ресурсам сети, необходимо включить маршрутизацию пакетов:

```bash
# Временно (до перезагрузки)
sysctl -w net.ipv4.ip_forward=1

# Постоянно
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p
```

### Настройка firewall (если включен)

```bash
# Разрешить WireGuard
ufw allow 51820/udp

# Разрешить веб-интерфейс (для локального доступа к web-интерфейсу wg-easy)
ufw allow 51821/tcp
```

## 4. Проброс порта на роутере

В настройках роутера создайте правило:

- **Внешний порт:** 51820
- **Протокол:** UDP
- **Внутренний IP:** IP-адрес вашей ВМ (например, 192.168.1.100)
- **Внутренний порт:** 51820

> ⚠️ **Важно:** **НЕ** пробрасываем порт **51821**. Он нужен только в локальной сети, чтобы управлять клиентами WG.

## 5. Запуск

```bash
cd /opt/wg-easy
docker compose up -d
```

## 6. Использование

1. Откройте веб-интерфейс: `http://IP_ВАШЕЙ_ВМ:51821`
2. Введите пароль
3. Создайте нового клиента
4. Отсканируйте QR-код приложением WireGuard на телефоне

## Проверка работоспособности

После подключения к VPN проверьте:

В терминале:

```bash
# На клиенте — ваш внешний IP должен совпадать с домашним
curl ifconfig.me

# Доступ к локальным ресурсам
ping 192.168.1.1
```

В браузере можно проверить при помощи [https://doesmyvpn.work/](https://doesmyvpn.work/)

## Полезные команды

```bash
# Просмотр логов
docker logs -f wg-easy

# Перезапуск
docker compose restart

# Остановка
docker compose down
```

---

_Автор: DonEx Code_
